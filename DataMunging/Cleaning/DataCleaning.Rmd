---
title: "Happiness_Project"
author: "Emma Horton"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Libraries

```{r}
library(dplyr)
library(here)
library(readr)
library(ggplot2)
library(tidyr)
library(stringr)

```

Set Root
```{r}
here::i_am("Cleaning/DataCleaning.rmd")
```


Read in Dataset

```{r}
df <- here("DataAnalysis", "Datasets", "WorldHappinessReport.csv")
df <- read.csv(df)
#View(df)

```

View Head
```{r}
#head(df)
#tail(df)
```

View Missing
```{r}
summary(df)
```
Cleaning Data for Regional Indicator

```{r}
df[df$Regional.Indicator == "",]
```

Missing Regions Replacement
```{r}
cleaning <- df %>%
  mutate(Regional.Indicator = case_when(
    (is.na(Regional.Indicator) | Regional.Indicator == "") & Country.Name == 'Angola' ~ "Southern Africa",
    (is.na(Regional.Indicator) | Regional.Indicator == "") & Country.Name == 'Belize' ~ "Central America",
    (is.na(Regional.Indicator) | Regional.Indicator == "") & Country.Name == 'Bhutan' ~ "South Asia",
    (is.na(Regional.Indicator) | Regional.Indicator == "") & Country.Name == 'Central African Republic' ~ "Central Africa",
    (is.na(Regional.Indicator) | Regional.Indicator == "") & Country.Name == 'Congo (Kinshasa)' ~ "Central Africa",
    (is.na(Regional.Indicator) | Regional.Indicator == "") & Country.Name == 'Cuba' ~ "Caribbean",
    (is.na(Regional.Indicator) | Regional.Indicator == "") & Country.Name == 'Czechia' ~ "Central Europe",
    (is.na(Regional.Indicator) | Regional.Indicator == "") & Country.Name == 'Djibouti' ~ "East Africa",
    (is.na(Regional.Indicator) | Regional.Indicator == "") & Country.Name == 'Eswatini' ~ "Southern Africa",
    (is.na(Regional.Indicator) | Regional.Indicator == "") & Country.Name == 'Guyana' ~ "Anglophone Caribbean",
    (is.na(Regional.Indicator) | Regional.Indicator == "") & Country.Name == 'Oman' ~ "Middle East",
    (is.na(Regional.Indicator) | Regional.Indicator == "") & Country.Name == 'Qatar' ~ "Middle East",
    (is.na(Regional.Indicator) | Regional.Indicator == "") & Country.Name == 'Somalia' ~ "East Africa",
    (is.na(Regional.Indicator) | Regional.Indicator == "") & Country.Name == 'Somaliland region' ~ "East Africa",
    (is.na(Regional.Indicator) | Regional.Indicator == "") & Country.Name == 'South Sudan' ~ "North Africa",
    (is.na(Regional.Indicator) | Regional.Indicator == "") & Country.Name == 'Sudan' ~ "North Africa",
    (is.na(Regional.Indicator) | Regional.Indicator == "") & Country.Name == 'Suriname' ~ "South America",
    (is.na(Regional.Indicator) | Regional.Indicator == "") & Country.Name == 'Syria' ~ "Middle East",
    (is.na(Regional.Indicator) | Regional.Indicator == "") & Country.Name == 'Trinidad and Tobago' ~ "Caribbean",
    (is.na(Regional.Indicator) | Regional.Indicator == "") & Country.Name == 'Turkiye' ~ "Central and Eastern Europe",
    (is.na(Regional.Indicator) | Regional.Indicator == "") & Country.Name == 'State of Palestine' ~ "West Asia",
    TRUE ~ Regional.Indicator
  ))

```

Verify Region does not contain empty values
```{r}
cleaning[cleaning$Regional.Indicator == "", ]
```
```{r}
cleaning[cleaning$Regional.Indicator == "NA", ]
```


Cleaning Data Median Values for Numeric Variables

```{r}
medians <- cleaning %>% 
  summarize(across(where(is.numeric), ~median(., na.rm = TRUE)))

cleaning <- cleaning %>%
  mutate(across(where(is.numeric), ~ifelse(is.na(.), medians[[cur_column()]], .)))

summary(cleaning)
```


```{r}
unique(cleaning$Regional.Indicator)
```

Attach Continents
```{r}
cleaning <- cleaning %>%
  mutate(Continent = case_when(
    Regional.Indicator %in% c("South Asia", "Commonwealth of Independent States", "Southeast Asia", 
                  "East Asia", "Middle East", "West Asia") ~ "Asia",
    Regional.Indicator %in% c("Central and Eastern Europe", "Western Europe", "Central Europe") ~ "Europe",
    Regional.Indicator %in% c("Middle East and North Africa", "Southern Africa", "Sub-Saharan Africa", 
                  "Central Africa", "East Africa", "North Africa") ~ "Africa",
    Regional.Indicator %in% c("Latin America and Caribbean", "North America and ANZ", "Central America", 
                  "Caribbean", "Anglophone Caribbean", "South America") ~ "Americas",
    Regional.Indicator == "North America and ANZ" ~ "Oceania",
    TRUE ~ "Other" 
  ))
```
Outlier Detection on Life Ladder

```{r}
boxplot(Life.Ladder ~ Continent, data = cleaning,
        main = "Life Ladder Distribution by Continent",
        xlab = "Continent", ylab = "Life Ladder")

```



Outlier Detection on Log.GDP.Per.Capita
```{r}
boxplot(Log.GDP.Per.Capita ~ Continent, data = cleaning,
        main = "Log.GDP.Per.Capita Distribution by Continent",
        xlab = "Continent", ylab = "Log.GDP.Per.Capita")
```

Outlier Detection on Social Support
```{r}
boxplot(Social.Support ~ Continent, data = cleaning,
        main = "Social Support Distribution by Continent",
        xlab = "Continent", ylab = "Social Support")
```
Outlier Detection on Healthy Life Expectancy

```{r}
boxplot(Healthy.Life.Expectancy.At.Birth ~ Continent, data = cleaning,
        main = "Healthy Life Expectancy Distribution by Continent",
        xlab = "Continent", ylab = "Healthy Life Expectancy")
```


Outlier Detection on Freedom.To.Make.Life.Choices

```{r}
boxplot(Freedom.To.Make.Life.Choices ~ Continent, data = cleaning,
        main = "Freedom in Life Choice Distribution by Continent",
        xlab = "Continent", ylab = "Freedom in Life Choice")
```

Outlier Detection on Generosity


```{r}
boxplot(Generosity ~ Continent, data = cleaning,
        main = "Generosity Distribution by Continent",
        xlab = "Continent", ylab = "Generosity")
```


Outlier Detection on Corruption Perception
```{r}
summary(cleaning)
boxplot(Perceptions.Of.Corruption ~ Continent, data = cleaning,
        main = "Perception of Corruption Distribution by Continent",
        xlab = "Continent", ylab = "Perception of Corruption")
```


Outlier Detection on Positive Affect by Region
```{r}
boxplot(Positive.Affect ~ Continent, data = cleaning,
        main = "Positive.Affect Distribution by Continent",
        xlab = "Continent", ylab = "Positive.Affect")
```


Outlier Detection on Negative Effect
```{r}
boxplot(Negative.Affect ~ Continent, data = cleaning,
        main = "Negative Effect Distribution by Continent",
        xlab = "Continent", ylab = "Negative Effect")
```

Save DataFrame in a Pretty Name
```{r}
cleaning -> happydf
```

Read in Auxiliary Dataset, Population and Pre-Process
```{r}
df <- here("Datasets", "WorldBank_Population", "PopulationData.csv")
here()
population <- read_csv(df, skip = 4)
population <- population[, c(1:2, 50:(ncol(population) - 1))]

population <- population %>%
  rename(Country.Name = `Country Name`,Country.Code = `Country Code`)


#View(population)
```

Gather Population Data
```{r}
population <- population %>%
  gather(key = "Year", value = "Population", -Country.Name, -Country.Code) %>%
    mutate(Year = as.integer(Year))
```


Attach Continents to Population
```{r}
#get unique countries from happydf
unique_countries <- happydf %>%
  select(Country.Name, Continent, Regional.Indicator) %>%
  distinct()

```

Join Population and Country Name Based on Year in New Set Happy Population

```{r}
happydf <- full_join(happydf, population, by = c("Country.Name", "Year"))
happydf

```

Read in COVID Case Statistics 

```{r}
covid <- here("Datasets", "StatisticsData", "WHO-COVID-19-global-data.csv")
covid <- read.csv(covid)
View(covid)


# Split for year element
covid[c('Year', 'Month', 'Day')] <- str_split_fixed(covid$Date_reported, '-', 3)
 
# Select columns of interest
covid <- 
  covid %>% 
  select(Year, Country_code, Country, WHO_region, New_cases, New_deaths) 

# Summarize the data by year
covid <- covid %>%
  group_by(Year, Country_code, Country, WHO_region) %>%
  summarize(
    Total_New_Deaths = sum(New_deaths, na.rm = TRUE),
    Total_New_Cases = sum(New_cases, na.rm = TRUE),
    .groups = 'drop'  # Ungroup data after summarizing
  )

names(covid)[names(covid) == "Country"] <- "Country.Name"

```
Join Happy DF with Covid

```{r}
class(happydf$Year)= "character"
str(happydf)
happydf <- full_join(happydf, covid, by = c("Country.Name", "Year"))
happydf$Year <- as.numeric(as.character(happydf$Year))

```



```{r}
happydf <- happydf %>% 
  filter(Continent %in% c("Asia", "Africa", "Europe", "Americas"))
  
# Plot
happydf %>%
  ggplot(aes(x=Year, 
              y=Life.Ladder, 
              group=Continent, 
              color=Continent)) +
    geom_smooth() +
    ggtitle("Happiness Over Time") +
    xlab("Time") +
    ylab("Happiness")


```


Export Data to CSV
```{r}
path <- here("Datasets", "HappyDataFrame.csv")
write.csv(happydf, path, row.names=FALSE)
```


